# 未找到錯誤整理：消費者 vs 老闆

以兩種身分整理會回傳「未找到」或導致使用者以為資料不見的錯誤路徑與修復建議。

---

## 一、消費者（一般使用者下訂單）

### 1. 會回傳 404 / 未找到的 API

| API | 情境 | 回傳訊息 | 前端是否顯示 |
|-----|------|----------|--------------|
| `POST /api/orders` | 當前世界的 world 已被刪除（binding 有 worldId 但 getWorldById 為 null） | `404` 找不到指定的世界 | ✅ 會（`showError(error.error)`） |
| `POST /api/worlds/join` | 輸入的世界代碼不存在 | `404` 找不到此世界代碼 | ✅ 會（`state.errorMessage`） |
| `POST /api/worlds/join` | 輸入的世界 ID 不存在 | `404` 找不到此世界 | ✅ 會（同上） |

### 2. 不會回傳 404 但會讓消費者以為「未找到」的邏輯問題（已修復）

- **「我的訂單」列表漏掉已取消訂單**  
  - **原因**：`GET /api/orders/my` 用 `getOrderItems(db, row.order_id)` 取 `orderWorldId`；已取消訂單會從 `orders` 表刪除，`getOrderItems` 回傳 `[]`，該筆被 `continue` 略過，消費者就看不到這筆訂單。  
  - **修復**：當 `orderItems` 為空時，改從 `order_history` 該筆的 `row.worldId` 取得世界；若 `row.worldId` 有值就納入結果，已取消的訂單也會出現在「我的訂單」中。  
  - **程式位置**：`src/index.js` 中 `GET /api/orders/my` 的迴圈內。

### 3. 消費者流程中「未找到」相關重點

- 菜單：`GET /api/menu` 僅回 403（未加入世界 / 世界未完成設定），不回 404。
- 送出訂單失敗時，若後端回 404「找不到指定的世界」，前端會顯示該錯誤訊息。

---

## 二、老闆（世界擁有者 / 管理端）

### 1. 會回傳 404 / 未找到的 API

| API | 情境 | 回傳訊息 | 前端是否顯示 |
|-----|------|----------|--------------|
| `PUT /api/worlds/order-format` | 當前世界已被刪除 | `404` 找不到世界 | 依前端是否有呼叫並用 `error.error` 顯示 |
| `PUT /api/worlds/display-format` | 同上 | `404` 找不到世界 | 同上 |
| `POST /api/worlds/:worldId/remove-member` | 目標使用者不在該世界 | `404` 找不到該成員 | ✅ 會（`showError(error.message)`） |
| `POST /api/worlds/leave` | 使用者根本沒加入該世界 | `404` 您尚未加入此世界 | 依前端是否有呼叫並顯示錯誤 |
| `DELETE /api/menu/items` | 品項不在菜單中 | `404` 找不到指定的品項 | 需確認前端有呼叫並顯示 `error.error` |
| `PUT /api/menu/items` | 舊品項名稱不存在 | `404` 找不到指定的品項 | 同上 |
| `GET /api/orders/:orderId` | 訂單不存在或已刪除 | `404` 找不到該訂單 | Web 前端目前未呼叫此 API（多為 LINE 或未來功能） |
| `PUT /api/orders/items/:itemId` | 品項 ID 不存在 | `404` 找不到該訂單品項 | 同上 |
| `POST /api/orders/:orderId/items` | 訂單不存在 | `404` 找不到該訂單 | 同上 |
| `DELETE /api/orders/items/:itemId` | 品項 ID 不存在 | `404` 找不到該訂單品項 | 同上 |
| `POST /api/orders/:orderId/cancel` | 訂單不存在 | `404` 找不到該訂單 | 同上 |
| `POST /api/orders/:orderId/restore` | 沒有可恢復的取消記錄 | `404` 找不到可恢復的訂單記錄 | 同上 |

### 2. 老闆流程中「未找到」相關重點

- **成員**：剔除成員時若目標已不在該世界，會回 404「找不到該成員」，前端有顯示。
- **菜單**：刪除/修改品項時若品項不存在會回 404「找不到指定的品項」，前端需確認有顯示 `error.error`。
- **訂單**：查單筆訂單、改數量、新增/刪除品項、取消、恢復等多為 LINE 或後續功能使用，Web 目前未用，但 404 訊息已定義。

---

## 三、總結與建議

1. **消費者**  
   - 會直接遇到的「未找到」：送出訂單時「找不到指定的世界」、加入世界時「找不到此世界代碼/此世界」。  
   - 已修復：「我的訂單」改為用 `order_history.worldId` 納入已取消訂單，避免消費者以為訂單「未找到」。

2. **老闆**  
   - 會直接遇到的「未找到」：剔除成員「找不到該成員」、刪除/修改菜單品項「找不到指定的品項」、設定格式時「找不到世界」、退出世界時「您尚未加入此世界」。  
   - 訂單相關 404（單筆訂單、品項、取消、恢復）目前多為 API/其他客戶端使用，前端若有新增操作再補上對應錯誤顯示即可。

3. **建議**  
   - 菜單刪除/修改品項的 API 若有在 Web 使用，請確認前端對 `!response.ok` 時讀取 `error.error` 並用 `showError` 或 `state.errorMessage` 顯示。  
   - 若希望「我的訂單」區分狀態，可再從 `order_history` 查該 `order_id` 是否有「訂單取消」記錄，回傳 `isCancelled` 供前端顯示「已取消」。
